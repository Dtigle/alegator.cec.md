@using CEC.Web.SRV.Resources

@{
    ViewBag.Title = MUI.Buildings;
}

<div class="box-content">
	<h4 class="page-header">@MUI.Buildings</h4>
	<div class="row">
        <div class="col-sm-3">
			@Html.Partial("_TreeViewLocalities" )
		</div>
		<div class="col-sm-9">
	        @Html.Partial("_AddressesBuildings" )
		</div>
	</div>
</div>

<script type="text/javascript">
    (function ($) {
        var currentRegionId = 0;
        $.onRegionSelect = function (regionId) {
            currentRegionId = regionId;
            var streetGrid = $('#addresses').jqGrid();
            streetGrid.jqGrid('setGridParam', { 'postData': { 'regionId': regionId } });
            streetGrid.trigger('reloadGrid', [{ page: 1 }]);
        };

        $.getRegionId = function () {

            return { regionId: currentRegionId };
        };

        $.AddBuilding = function () {
	        hideContextMenu();
		    if (currentRegionId == 0) {
			    BootstrapDialog.alert({ message: '@MUI.RegionNotSelectedAlertMessage', title: '@MUI.DialogTitle_Information' });
			    return;
		    }

		    saveBuildingAddress();
	    };

    	$.EditBuilding = function () {
    		hideContextMenu();
		    if (currentRegionId == 0) {
			    BootstrapDialog.alert({ message: '@MUI.RegionNotSelectedAlertMessage', title: '@MUI.DialogTitle_Information' });
			    return;
		    }

		    var selections = $("#addresses").jqGrid('getGridParam', 'selarrrow');

		    if (selections == null || selections.length == 0) {
			    BootstrapDialog.alert({ message: '@MUI.Address_NothingSelected', title: '@MUI.DialogTitle_Information' });
			    return;
		    }
		    if (selections.length > 1) {
			    BootstrapDialog.alert({ message: '@MUI.TooManyRecordsSelected', title: '@MUI.DialogTitle_Information' });
			    return;
		    }

		    var addressId = selections[0];
		    saveBuildingAddress(addressId);
	    };

        function saveBuildingAddress(addressId) {
            var url = '@Url.Action("SaveBuildingAddress", "Address")';

            var addressParam = '';
            var dialogTitle = '@MUI.AddressBuildingAdd_DialogTitle';
            if (addressId != undefined) {
                addressParam = '&addressId=' + addressId;
                dialogTitle = '@MUI.AddressBuildingEdit_DialogTitle';
            }

            $.openDialog($(this), {
                url: url + '?regionId=' + currentRegionId + addressParam,
                title: dialogTitle,
                onSubmit: function () {
                    $("#addresses").trigger('reloadGrid');
                },

            });

        };

    	$.DeleteAddress = function () {
    		hideContextMenu();
            if (currentRegionId == 0) {
                BootstrapDialog.alert({ message: '@MUI.RegionNotSelectedAlertMessage', title: '@MUI.DialogTitle_Information' });
                return;
            }

            var selections = $("#addresses").jqGrid('getGridParam', 'selarrrow');

            if (selections == null || selections.length == 0) {
                BootstrapDialog.alert({ message: '@MUI.Address_NothingSelected', title: '@MUI.DialogTitle_Information' });
                return;
            }
            if (selections.length > 1) {
                BootstrapDialog.alert({ message: '@MUI.TooManyRecordsSelected', title: '@MUI.DialogTitle_Information' });
                return;
            }

            var addressId = selections[0];

            var url = '@Url.Action("DeleteAddress","Address")';

            BootstrapDialog.confirm('@MUI.AddressBuildingDelete_Message', function (result) {
                if (result) {
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: { addressId: addressId },
                        success: function (returnData) {
                            $("#addresses").trigger('reloadGrid');
                        }
                    });
                }

            });

        };
    })(jQuery);
</script>